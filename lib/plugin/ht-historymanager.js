!function(L,H){"use strict";var a=L.ht,y=a.Default,L=y.def,B=y.getInternal();a.HistoryManager=function(L){this._histories=[],this.setDataModel(L)},L(a.HistoryManager,H,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,material:!0,animationStart:!0,animationStop:!0,animationPause:!0,animationResume:!0,animationIteration:!0,"*":!0},ignoreDataModelPropertyMap:{},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){var L,H;this._disabled||(H=(L=this)._betweenTransaction++,1===L._betweenTransaction&&(L._transactionHistories={}),L.fp("betweenTransaction",H,L._betweenTransaction))},endTransaction:function(){if(!this._disabled&&0!==this._betweenTransaction){var L,H=this;if(1===H._betweenTransaction){if(H._transactionHistories){var _,h=[];for(_ in H._transactionHistories){var z=H._transactionHistories[_];y.isArray(z)||(z=[z]),h.push.apply(h,z)}h.length&&(H.addActions(h),H.setHistoryIndex(H._histories.length-1,!0))}delete H._transactionHistories}0<H._betweenTransaction&&(L=H._betweenTransaction--,H.fp("betweenTransaction",L,H._betweenTransaction))}},setDataModel:function(L){var H=this,_=H._dataModel;_!==L&&(_&&(delete _._historyManager,_.ump(H.handleDataModelPropertyChange,H),_.umm(H.$5p,H),_.umd(H.$6p,H),_.removeHierarchyChangeListener(H.handleHierarchyChange,H),_.removeIndexChangeListener(H.handleIndexChange,H)),(H._dataModel=L)&&(L._historyManager=H,L.mp(H.handleDataModelPropertyChange,H),L.mm(H.$5p,H),L.md(H.$6p,H),L.addHierarchyChangeListener(H.handleHierarchyChange,H),L.addIndexChangeListener(H.handleIndexChange,H)),H.fp("dataModel",_,L),H.clear())},setHistoryIndex:function(L,H){var _=this,h=_._historyIndex,z=_._histories.length;L<-1?L=-1:z<=L&&(L=z-1),h!==L&&(H||(0<(z=L-h)?_.$2p(z):z<0&&_.$1p(-z)),_._historyIndex=L,_.fp("historyIndex",h,L),_.dataModel&&_.dataModel.onHistoryManagerChanged())},setMaxHistoryCount:function(L){var H=this,_=H._histories,h=H._maxHistoryCount;h!==(L=!L||L<=0?10:L)&&(H._maxHistoryCount=L,H.fp("maxHistoryCount",h,L),_.length>L&&H.clear())},cloneValue:function(L,H,_){return a.Default.clone(L)},isPropertyUndoable:function(L,H){return L&&!this.ignoredPropertyMap[L]},isIndexUndoable:function(L){return!1},isDataModelPropertyUndoable:function(L,H){return L&&!this.ignoreDataModelPropertyMap[L]},$5p:function(L){this.handleChange(L,L.kind)},$6p:function(L){this.handleChange(L,"property")},handleHierarchyChange:function(L){this.handleChange(L,"hierarchy")},handleIndexChange:function(L){this.handleChange(L,"index")},handleDataModelPropertyChange:function(L){this.handleChange(L,"dataModelProperty")},toChildrenInfo:function(L){var H={};return H.data=L,H.children=[],L.eachChild(function(L){H.children.push(this.toChildrenInfo(L))},this),H},restoreChildren:function(L){var _=L.data;L.children.forEach(function(L){var H=L.data;H.getParent()!==_&&_.addChild(H),this._dataModel.contains(H)||this._dataModel.add(H),this.restoreChildren(L)},this)},handleChange:function(L,H){var _,h,z,r,F=this;F._disabled||F._isUndoRedoing||y.loadingRefGraph||(F._histories,_=L.data,h=L.property,_&&(_._refGraph||_ instanceof a.RefGraph)||("property"===H?F.isPropertyUndoable(h,_)&&(r={kind:H,data:_,property:h,oldValue:F.cloneValue(L.oldValue,_,h),newValue:F.cloneValue(L.newValue,_,h),event:L}):"hierarchy"===H||"index"===H&&F.isIndexUndoable(L)?r={kind:H,data:_,oldIndex:L.oldIndex,newIndex:L.newIndex,event:L}:"clear"===H?r={kind:H,json:L.json,event:L}:"add"===H?((r={kind:H,data:_,event:L,childrenInfo:this.toChildrenInfo(_),parent:_.getParent()}).parent&&(z=F._dataModel.getSiblings(_),r.siblingsIndex=z.indexOf(_)),_ instanceof a.Node&&(r.host=_.getHost(),r.attaches=_.getAttaches()?_.getAttaches().toArray():void 0),_ instanceof a.Edge&&(r.source=_.getSource(),r.target=_.getTarget())):"remove"===H?r={kind:H,data:_,event:L}:"dataModelProperty"===H&&F.isDataModelPropertyUndoable(h,_)&&(r={kind:H,property:h,oldValue:F.cloneValue(L.oldValue,_,h),newValue:F.cloneValue(L.newValue,_,h),event:L}),F.addHistory(r)))},addHistory:function(L){var H,_,h=this;L&&(h._betweenTransaction?(H=(L.data?L.data._id:0)+"_"+L.kind+"_"+L.property,"property"===L.kind||"dataModelProperty"===L.kind?((_=h._transactionHistories[H])&&(L.oldValue=_.oldValue),h._transactionHistories[H]=L):(_=h._transactionHistories[H])?(_=y.isArray(_)?_:h._transactionHistories[H]=[_]).push(L):h._transactionHistories[H]=L):(h.addActions([L]),h.setHistoryIndex(h._histories.length-1,!0)))},addActions:function(L){var H=this,_=H._histories;(_=_.slice(0,H._historyIndex+1)).push(L),_.length>H._maxHistoryCount&&(_=_.slice(_.length-H._maxHistoryCount)),H.setHistories(_)},canUndo:function(){return!this._disabled&&0<=this._historyIndex&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&-1<=this._historyIndex&&this._historyIndex<this._histories.length-1},undo:function(L){this.setHistoryIndex(this._historyIndex-(L=!L||L<=0?1:L))},$1p:function(L){if(this.canUndo()){var H,_=this,h=_._histories,z=_._historyIndex,r=0;for(_._isUndoRedoing=!0,y.setIsolating(!0);0<L;)0<=z&&z<h.length&&(r++,H=h[z],z--,_.undoImpl(H)),L--;y.setIsolating(!1),delete _._isUndoRedoing,_.afterUndo(r)}},undoImpl:function(L){for(var H=this._dataModel,_=L.length-1;0<=_;_--){var h,z=L[_],r=z.kind,F=z.data,t=z.property,W=z.event,s=this.cloneValue(z.oldValue,F,t);z.undo?z.undo():"add"===r?H.remove(F,{keepChildren:!0}):"remove"===r?H.contains(F)||H.add(F,W.rootsIndex,W.datasIndex):"clear"===r?H.deserialize(y.clone(z.json)):"property"===r?"parent"===t?s?s.addChild(F,W.oldIndex):(F.setParent(s),0<=W.oldIndex&&H.moveTo(F,W.oldIndex)):(h=null,0===t.indexOf("a:")?(h="attr",t=t.replace("a:","")):0===t.indexOf("s:")?(h="style",t=t.replace("s:","")):0===t.indexOf("f:")&&(h="field",t=t.replace("f:","")),B.setPropertyValue(F,h,t,s)):"dataModelProperty"===r?(h=null,0===t.indexOf("a:")?(h="attr",t=t.replace("a:","")):0===t.indexOf("s:")?(h="style",t=t.replace("s:","")):0===t.indexOf("f:")&&(h="field",t=t.replace("f:","")),B.setPropertyValue(H,h,t,s)):"hierarchy"===r?H.moveTo(F,z.oldIndex):"index"===r?H.moveToIndex(F,z.oldIndex):"selection"===r&&H.sm().ss(z.oldValue)}},afterUndo:function(L){},redo:function(L){this.setHistoryIndex(this._historyIndex+(L=!L||L<=0?1:L))},$2p:function(L){if(this.canRedo()){var H,_=this,h=_._histories,z=_._historyIndex,r=0;for(_._isUndoRedoing=!0,y.setIsolating(!0);0<L;)-1<=z&&z<h.length-1&&(r++,H=h[++z],_.redoImpl(H)),L--;y.setIsolating(!1),delete _._isUndoRedoing,this.afterRedo(r)}},redoImpl:function(L){for(var H=this._dataModel,_=0;_<L.length;_++){var h,z=L[_],r=z.kind,F=z.data,t=z.property,W=z.event,s=this.cloneValue(z.newValue,F,t);z.redo?z.redo():"add"===r?(z.parent&&!F.getParent()&&z.parent.addChild(F,z.siblingsIndex),H.contains(F)||H.add(F,W.rootsIndex,W.datasIndex),this.restoreChildren(z.childrenInfo),F instanceof a.Node&&(F.setHost(z.host),z.attaches&&z.attaches.forEach(function(L){L.setHost(F)})),F instanceof a.Edge&&(F.setSource(z.source),F.setTarget(z.target))):"remove"===r?H.remove(F):"clear"===r?H.clear():"property"===r?"parent"===t?s?s.addChild(F,W.newIndex):(F.setParent(s),0<=W.newIndex&&H.moveTo(F,W.newIndex)):(h=null,0===t.indexOf("a:")?(h="attr",t=t.replace("a:","")):0===t.indexOf("s:")?(h="style",t=t.replace("s:","")):0===t.indexOf("f:")&&(h="field",t=t.replace("f:","")),B.setPropertyValue(F,h,t,s)):"dataModelProperty"===r?(h=null,0===t.indexOf("a:")?(h="attr",t=t.replace("a:","")):0===t.indexOf("s:")?(h="style",t=t.replace("s:","")):0===t.indexOf("f:")&&(h="field",t=t.replace("f:","")),B.setPropertyValue(H,h,t,s)):"hierarchy"===r?H.moveTo(F,z.newIndex):"index"===r?H.moveToIndex(F,z.newIndex):"selection"===r&&H.sm().ss(z.newValue)}},afterRedo:function(L){},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);